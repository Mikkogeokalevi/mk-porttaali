<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK Admin - Triplettigeneraattori</title>
    <style>
        body { font-family: sans-serif; background-color: #1e1e2e; color: #cdd6f4; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #89b4fa; }
        
        textarea {
            width: 100%;
            height: 200px;
            background-color: #313244;
            color: #fff;
            border: 1px solid #45475a;
            padding: 10px;
            font-family: monospace;
            margin-bottom: 20px;
        }

        button {
            background-color: #89b4fa;
            color: #1e1e2e;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 5px;
            margin-right: 10px;
        }
        button:hover { background-color: #b4befe; }
        button.save-btn { background-color: #a6e3a1; }

        .status { margin-top: 10px; font-weight: bold; }
        .preview { margin-top: 20px; background: #313244; padding: 20px; border-radius: 8px; }
        .preview h3 { color: #f9e2af; margin-top: 0; }
        .cat-block { margin-bottom: 10px; border-bottom: 1px solid #45475a; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Triplettikuntien Päivitystyökalu</h1>
    <p>1. Maalaa taulukko Geocache.fi-sivulla (Paikkakunta, Maakunta, Tradi, Multi, Mysse...).<br>
       2. Kopioi (Ctrl+C).<br>
       3. Liitä alle (Ctrl+V) ja paina "Prosessoi".</p>

    <textarea id="rawInput" placeholder="Liitä taulukon data tähän..."></textarea>
    
    <div>
        <button onclick="processData()">1. Prosessoi data</button>
        <button id="saveBtn" class="save-btn" onclick="saveToFirebase()" style="display:none;">2. Tallenna tietokantaan</button>
    </div>

    <div id="statusMsg" class="status"></div>

    <div id="previewArea" class="preview" style="display:none;">
        <h3>Esikatselu (Tunnistetut kategoriat):</h3>
        <div id="previewContent"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Firebase Config (SAMA KUIN SOVELLUKSESSA)
    const firebaseConfig = {
      apiKey: "AIzaSyDxDmo274iZuwufe4meobYPoablUNinZGY",
      authDomain: "mk-porttaali.firebaseapp.com",
      projectId: "mk-porttaali",
      storageBucket: "mk-porttaali.firebasestorage.app",
      messagingSenderId: "220899819334",
      appId: "1:220899819334:web:6662b7b1519f4c89c32f47"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let processedCategories = {};

    window.processData = () => {
        const raw = document.getElementById('rawInput').value;
        const lines = raw.split('\n');
        const categories = {
            1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: []
        };
        
        let count = 0;

        lines.forEach(line => {
            const cols = line.split('\t');
            // Oletus: Geocache.fi taulukon rakenne
            // Col 0: Index (1)
            // Col 1: Paikkakunta (Akaa)
            // Col 2: Maakunta (Pirkanmaa)
            // Col 3: Tradi
            // Col 4: Multi
            // Col 5: Mysse
            
            // Varmistetaan että rivillä on dataa (vähintään 6 saraketta)
            if (cols.length < 6) return;
            
            // Ohitetaan otsikkorivi jos se tarttui mukaan (tarkistetaan onko "Tradi" tai vastaava teksti sarakkeessa)
            if (isNaN(parseInt(cols[3]))) return;

            const kunta = cols[1].trim();
            const tradi = parseInt(cols[3]) || 0;
            const multi = parseInt(cols[4]) || 0;
            const mysse = parseInt(cols[5]) || 0;

            const item = { name: kunta, t: tradi, m: multi, q: mysse };

            // KATEGORIOINTI LOGIIKKA (Alkuperäisen HTML:n mukainen)
            
            if (tradi === 0 && multi === 0 && mysse === 0) {
                categories[1].push(item);
            } else if (tradi > 0 && multi === 0 && mysse === 0) {
                categories[2].push(item);
            } else if (tradi === 0 && multi > 0 && mysse === 0) {
                categories[3].push(item);
            } else if (tradi === 0 && multi === 0 && mysse > 0) {
                categories[4].push(item);
            } else if (tradi > 0 && multi > 0 && mysse === 0) {
                categories[5].push(item);
            } else if (tradi === 0 && multi > 0 && mysse > 0) {
                categories[6].push(item);
            } else if (tradi > 0 && multi === 0 && mysse > 0) {
                categories[7].push(item);
            } else if (tradi > 0 && multi > 0 && mysse > 0) {
                categories[8].push(item);
            }
            
            count++;
        });

        // Lajitellaan aakkosjärjestykseen
        for (let i = 1; i <= 8; i++) {
            categories[i].sort((a, b) => a.name.localeCompare(b.name));
        }

        processedCategories = categories;
        
        // Näytä esikatselu
        const preview = document.getElementById('previewContent');
        preview.innerHTML = '';
        for (let i = 1; i <= 8; i++) {
            const count = categories[i].length;
            if (count > 0) {
                const sample = categories[i].slice(0, 3).map(k => k.name).join(', ');
                preview.innerHTML += `<div class="cat-block"><strong>Kategoria ${i} (${count} kpl):</strong> ${sample}...</div>`;
            }
        }

        document.getElementById('statusMsg').textContent = `Prosessoitu ${count} kuntaa. Tarkista esikatselu ja tallenna.`;
        document.getElementById('statusMsg').style.color = '#a6e3a1';
        document.getElementById('previewArea').style.display = 'block';
        document.getElementById('saveBtn').style.display = 'inline-block';
    };

    window.saveToFirebase = async () => {
        const status = document.getElementById('statusMsg');
        try {
            status.textContent = "Tallennetaan...";
            
            // Tallennetaan data Firestoreen 'stats' kokoelmaan, dokumenttiin 'tripletti'
            await setDoc(doc(db, "stats", "tripletti"), {
                data: processedCategories,
                lastUpdated: serverTimestamp(),
                updatedByString: new Date().toLocaleString('fi-FI')
            });

            status.textContent = "✅ Tallennettu onnistuneesti! Tiedot näkyvät nyt Porttaalissa.";
            setTimeout(() => {
                document.getElementById('rawInput').value = '';
                document.getElementById('previewArea').style.display = 'none';
                document.getElementById('saveBtn').style.display = 'none';
            }, 3000);

        } catch (e) {
            console.error(e);
            status.textContent = "❌ Virhe tallennuksessa: " + e.message;
            status.style.color = '#f38ba8';
        }
    };
</script>

</body>
</html>
